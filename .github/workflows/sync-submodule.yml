name: Update Submodule After PR Merged

on:
  pull_request_target:
    types: [closed]
    branches: [master, stable, ci-test*]

jobs:
  update:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ci-test-1
          submodules: true
          token: ${{ secrets.PAT_REVIEW }}

      - name: Update submodule
        run: |
          current_branch=$(echo ${{ github.ref }} | sed -e "s/refs\/heads\///g")
          pr_number=${{ github.event.pull_request.number }}
          new_branch="${current_branch}-${pr_number}"
          cd tests/cassettes
          git fetch origin
          git checkout master
          git merge --no-ff $new_branch
          git push origin master
